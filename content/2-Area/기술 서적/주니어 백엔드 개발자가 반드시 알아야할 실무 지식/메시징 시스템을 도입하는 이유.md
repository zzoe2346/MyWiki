---
tags:
  - ing
created: 2025-07-24
---
보통 다른 시스템간에 비동기로 연동할 때 주로 사용하는 방식은 메시징 시스템을 차용한다. 시스템간에 메시징 시스템이라는게 하나더 끼어들어가서 복잡해지는대신 다른 이점을 얻을 수 있다.

이점
- 시스템간에 서로 영향이 없다
- 메시징 시스템이 시스템 A가 보낸 메시지를 일단 저장하고 시스템 B가 여력이 될때 보내면 특정 시스템에 부하가 생겨도 메시지 전송이 보장됨.
- 확장이 용이하다. 예를들어 A가 C에도 데이터를 전송해야한다는 요구사항이 생겼사 치자. 만약, A에 직접 데이터를 전송하는 로직이 있었다면 C에 전송하는 코드를 또 추가해야한다. OCP 그러나 메시징 시스템을 이용하념 C를 메시징 시스템에 연결하기만 하면된다. 이러면 C를 위해 시스템 A의 코드는 건드릴 필요가 없다.

메시징 시스템에서 사용하는 용어
생산자(producer), 소비자(consumer) 또는 게시(pub), 구독(sub)이라고도 표현.

카프카특징
- 높은 처리량. 초당 백 만 개 이상의 메시지 처리 가능한 능력 보유.
- 수평 확장 용이. 서버(브로커), 파티션, 소비자를 늘리면 됨.
- 메시지를 파일에 보관하여 메시지 유실을 방지.
- 1개의 토픽이 여러 파티션 가질 수 있는데, 파티션 단위로 순서를 보장.
- 토픽 수준에서는 순서 보장 불가.
- 소비자는 메시지를 언제든 재처리 가능.
- 풀(pull) 모델 사용. 소비자가 카프카 브로커에서 메시지를 읽어 가는 방식.
레빗MQ 특징
- 클러스터 통해 처리량 높일 수 있다. 단, 카프카보다 많은 자원 요구.
- 메모리에만 메시지를 보관하는 큐 설정 시, 장애 상황 시 메시지 유실 가능성 존재.
- 메시지는 큐에 등록된 순서대로 소비자에게 전송.
- 메시지가 소비자에게 전달됐는지 확인하는 기능 제공.
- 푸시 모델 사용. 래빗MQ 브로커가 소비자에 메시지 전송함. 소비자의 성능이 느려지면 큐에 과부하 걸려 전반적 성능 저하 발생 가능.
- 다재 다능. AMQP, STOMP 등 여러 프로토콜 지원
- pub/sub, request/response, point-to-point 패턴 지원.
- 우선순위 지정해서 순서 변경 가능.

레디스 pub/sub 특징
- 메모리 사용하여 지연 시간 짧고, 래빗MQ 대비 처리량 높음.
- 구독자 없으면 메시지 유실됨.
- 기본적으로 영구 메시지 지원 안함.
- 모델이 단순하여 사용 용이.

## 메시지 생성 측 고려 사항
생성 시 고려해야 할 점은 바로 메시지 유실. 예를 들어 메시지 전송 과정에서 타임아웃이 발생할 수 있다. 이 문제는 생상자와 메시징 시스템 간의 네트워크 연길이 불안정하면 언제든 발생 가능함. 이때 해결법은 3가지로 축약 가능.
- 무시
- 재시도
- 실패 로그
무시의 경우

메시지는 유실. 메시지 용도에 따라 무시가 허용될수도 있긴함.

재시도의 경우

일시적 네트워크 불안정 등과 같은 문제에서는 재시도를 통해 해결될수있다. 하지만 메시지를 재전송하는 과정에서 중복된 메시지가 전송될 수 도 있다. 실제로는 전송에 성공했는데 일시적인 네트워크 오류로 전송에 실패한것으로 인지하고 재시도할 수 있기 때문. 메시징 시스템이 중복 수신 방지하는 기능 없다면 소비자가 알아서 처리하면됨.

실패 로그 경우

로그를 남기면 이거 보고 후처리가 가능.

번외) 글로벌 트랜잭션
글로벌 트랜잭션 쓰면 여러 자원(여러 DB)에 대한 변경을 한 트랜잭션으로 묶어 처리 가능. 예를 들어 A DB는 커밋되었는데 B DB는 오류가 발생했다면 A,B 모두를 롤백 가능.

글로벌 트랜잭션을 구현하는 알고리즘으로 2-Phase Commit 을 사용하는데 그냥 글로벌 트랜잭션을 2PC라고도 표현하기도 함.

## 메시지 소비 측 고려 사항
메시지 소비자는 다음 2가지 이유로 동일한 메시지를 중복해서 처리할 수 있음.
- 메시지 생산자가 같은 메시지를 메시징 시스템에 2번 전송
- 소비자가 메시지를 처리하는 과정에서 오류가 발생하여 메시지 재수신
메시지 생산자가 메시지에 고유 식별자 처리를 했다면 소비자가 이를 Set으로 관리해서 중복을 방지 할 수 있음.

## 메시지 종류
이벤트 메시지 예
- 주문함
- 로그인 실패함
- 상품 정보 실패함
- 배송 완료함
이벤트는 어떤 일이 발생했음을 알려주는 메시지.
이벤트는 정해진 수신자 없음. 해당 이벤트에 관심있는 소비자가 메시지를수신하는 방ㅎ식


커맨드 예
- 포인트 지급하기
- 로그인 차단하기
- 배송 완료 문자 발송하기
메시지 수신 측이 할 기능 실행에 초점.
커맨드는 정해진 수신자 존재.



궁극의 일관성(eventual consistency)
최종적 일관성, 결과적 일관성이라고도 불림. 이 모델은 두 데이터 저장소간 일관성 보장하긴 하지만, 즉시가 아닌 일정 시간이 지난 후에야 일관성이 맞추어 진다는 특징 지님.

즉, 일시적으로 두 저장소간 데이터 불일치 상태가 생길 수 있는 것.

비동기 메시징 방식도 이와 유사한 특성 가짐. 배송 서비스에서 배송 상태를 완료로 변경한다 하더라도, 해당 변경 내용이 메시지를 통해 주문 서비스로 전달 전까지는 주문 서비스의 상태는 여전히 배송 중 일것임. 메시지 전파 전까지는 이런 불일치상태가 있을수 있다.