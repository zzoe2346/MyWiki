---
tags:
  - query
  - concurency
created: 2025-07-27
---
```
//subject 조회
Subject subject = jdbcTemplate.queryForObject(
	"select id, joinCount, ... from SUBJECT where id = ?", mapperCode, id);
)

//참여 데이터 추가
joinToSubject(joinData, subject);  //SUBJECT_JOIN 테이블에 추가

// 주제 데이터의 참여자 수 증가
jdbcTemplate.update(
	"update SUBJECT set joinCount = ? where id = ?", subject.getJoinCount()+1, subject.getId()
);
```

위 코드는 조회시점이 같을때 같은 객체 데이터를 가지게 되어 동시성 문제가 발생 충분히 가능함.

이걸 해결하기 위해 선점 잠금(응답 시간 길어질 가능성 존재)이나 비선점 잠금(변경 실패 에러 자주 발생 가능성 존재)하면 되긴함.

그런데 잠금 안쓰고 참여자 수 증가하는 방법이 있는데 바로 "증분 쿼리".

다음과 같이 쓰면 됨
```sql
update SUBJECT set joinCount = joinCount + 1 where id = ?
```

DB는 joinCount = joinCount + 1을 원자적 연산 처리함. DB는 동일 데이터에 대한 원자적 연산이 동시에 실행될때 이를 순차적으로 실행함. SERIALIZE

> 증분 쿼리는 DBMS따라 원자적 연산 아닐수있으니 사용하는 DBMS에 따라 검증이 필요.